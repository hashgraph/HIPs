---
hip: 584
title: EVM Module
author:  Ivan Kavaldzhiev <ivan.kavaldzhiev@limechain.tech>, Mustafa Uzun <mustafa.uzun@limechain.tech>
type: Standards Track
category: Service
needs-council-approval: Yes
status: Draft
created: 2022-09-27
discussions-to: https://github.com/hashgraph/hedera-improvement-proposal/discussions/586
---

## Abstract

Encapsulating Hedera smart contract EVM specific logic in a library.
It would expose interfaces that will allow different implementations.
Mirror node would build ethereum-related REST APIs on top of the library. 
Mirror nodes could use the library to simulate a transaction and the output would be used to 
populate the return value for the REST API that is invoked. 
Consensus nodes would also use the library and keep their existing logic by providing specific interface implementations.

## Motivation

Extracting common Hedera smart contract EVM logic in a single place

Enabling free read-only queries.

Enabling free gas estimate for a given transaction.

Enabling free transaction simulations.

## Rationale

In order to be possible to both execute and simulate transactions, run by the EVM used inside `hedera-node`,
we need to extract a module encapsulating all of the EVM logic.

The resulting library would allow us to fulfil the following use cases:

- Execute transactions in a regular flow with committing changes to state
- Execute transaction simulations that perform read-only operations
- Execute transaction simulations that perform speculative writes without committing changes to state
- Execute transaction simulations that perform speculative writes using historical data for transaction replay, 
without committing changes to state

## User stories

- As a developer, I want to have a library with common Hedera smart contract EVM logic that I can reuse in different projects
- As a user, I want to perform `eth_call` calls from the Ethereum JSON-RPC standard
- As a user, I want to perform `eth_gasEstimate` calls from the Ethereum JSON-RPC standard

## Specification

### EVM Library Definition

We want the EVM library to be used by multiple clients like the `hedera-services` and `hedera-mirror-node` repos
and to be able to be extended for a future use from additional clients.

To facilitate differences, we need to define interfaces, which would be inside the library 
and each client of the library (in this case `hedera-node` and `mirror-node`) would provide its own implementation.

### Mirror Node

Information will be made available via new REST APIs

#### Read-only queries REST API

A new  `/api/v1/contracts/call` REST API will be added to execute read-only queries.

The following JSON represents a typical request body:
```json
{
  "block": "latest", 
  "data": "0x81a73ad500000000000000000000000000000000000000000000000000000000000004e5", 
  "from": "0x00000000000000000000000000000000000004e2", 
  "gas": "0x76c0", 
  "gas_price": "0x76c0", 
  "to": "0x00000000000000000000000000000000000004e4", 
  "value": "0x0"
}
```
The following JSON represents a typical response result with the information read in the query:
```json
{
    "result": "0x000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000037474740000000000000000000000000000000000000000000000000000000000"
}
```

#### Estimate gas usage REST API

A new `/api/v1/contracts/gasestimate` REST API will be added to estimate gas usage

The following JSON represents a typical request body:
```json
{
  "block": "latest", 
  "data": "0xd46e8dd67c5d32be8d46e8dd67c5d32be8058bb8eb970870f072445675058bb8eb970870f072445675", 
  "from": "0x00000000000000000000000000000000000004e2", 
  "gas": "0x76c0", 
  "gas_price": "0x76c0", 
  "to": "0x00000000000000000000000000000000000004e3", 
  "value": "0x0"
}
```
The following JSON represents a typical response result with the gas amount that is estimated to be used by the EVM:
```json
{
    "result": "0x3234333230"
}
```

## Backwards Compatibility

Since the library would duplicate some code inside `hedera-node`, there would be a need to extract
and remove this code from `hedera-node` and start using `hedera-evm` as a dependency inside `hedera-node`.
In this way `hedera-node` and `mirror-node` would reuse the same code base, and we would avoid code duplications.

`Mirror Nodes` that will support the new REST APIs should have enabled importing of `CONTRACT_BYTECODE` and `CONTRACT_STATE_CHANGE` 
sidecar types. Otherwise, executing the endpoints would result in missing runtime bytecode for execution
or using stale contract storage data.

## Security Implications

There would be some security implementations for `Mirror Nodes`. Since the invocation of `eth_call` and `eth_gasEstimate` RPC calls 
would be free of charge and the `Mirror Nodes` donâ€™t have throttle mechanism, some attack vectors would be possible. 
The Nodes could be overloaded with huge amount of calls or calls invoking smart contract methods with huge gas usage, 
both of which might take more system usage and slow down the network for other users. A rate limit mechanism will be implemented,
so that the load put on Mirror Nodes to be balanced.

## How to Teach This

Respective documentation will be added.

## Reference Implementation

## Rejected Ideas

None.

## Open Issues

None.

## References

## Copyright/License

This document is licensed under the Apache License, Version 2.0 --
see [LICENSE](../LICENSE) or (https://www.apache.org/licenses/LICENSE-2.0)