---
hip: 435
title: Record Stream V6
author: Stoyan Panayotov <stoyan.panayotov@limechain.tech>
type: Standards Track 
category: Service
needs-council-approval: Yes
status: Draft
last-call-date-time: 
created: 2022-04-13
discussions-to: https://github.com/hashgraph/hedera-improvement-proposal/discussions/436
updated: 
requires: 
---

## Abstract

Updates the record file definition to be done via a protobuf.

Introduces Sidecar records - a generic way for Hedera nodes to externalise additional information about transactions that is not part of TransactionRecords.

Includes BlockNumber changes for the record files.

## Motivation

Using a protobuf definition for the record file schema is far preferable to having a custom parser or random specification someplace (currently a word doc).
The goal is to be able to externalise verbose information about transaction executions without bloating the main TransactionRecord object with potentially unnecessary information and requiring mirror nodes to always download and process that information.

## Rationale

There are use-cases requiring a detailed and verbose output for a HAPI transaction execution. Users of Hedera should have the option to query a mirror node for this information. Meanwhile, bloating the TransactionRecords with information that would be unnecessary in most cases is not an ideal option. It is a much better design decision to create sidecar record files that can be downloaded and processed only by interested parties.

**Design Goal #1**
Mirror nodes should not be required to download and process verbose transaction information. The sidecar transaction records will be externalised in separate record files.

**Design Goal #2**
One transaction can have 0, 1 or more than 1 sidecar records related to it located in 0, 1 or more record files.

**Design Goal #3**
It should be possible and relatively easy to add new types of sidecar transaction records.

## User stories

As a Hedera user, I want the to have the ability to access verbose information about transactions.

As an operator of a mirror node, I want the ability to download and process only the most important record-related information that is externalised as part of the main RecordFile.

As an operator of a mirror node, I want the ability to download sidecar record files containing all the information about records execution that a Hedera node can provide.

## Specification

Introduce a sidecar transaction record protobuf message and a sidecar record file protobuf message to enable tracking of additional information about records execution.

### Record Stream File Changes

A new version (V6) of the record stream file format will be created using the following protobufs:

```
message RecordFileObject {
  Transaction transaction = 1;
  TransactionRecord record = 2;
}
```

`Transaction` and `TransactionRecord` are already defined as protobuf messages and are used by the Record Stream algorithm. No changes will be required for these messages.

`RecordFileObjects` are serialized in record stream files.

```
message RecordStreamFile {

  // Version of HAPI that was used to serialise the file
  SemanticVersion hapiProtoVersion = 1;

  // Running Hash of all RecordFileObjects before writing this file.
  HashObject startObjectRunningHash = 2; 

  // List of all the record file objects from that period.
  repeated RecordFileObject fileObjects = 3; 

  // Running Hash of all RecordFileObjects before closing this file.
  HashObject endObjectRunningHash = 4; 

  // The block number associated with this period.
  int64 blockNumber = 5; 

  // List of the hashes of all the Sidecar record files created for the same period.
  // Allows multiple sidecar files to be linked to this RecordStreamFile
  repeated bytes SideCarFileHash = 6; 
}
```

```
message HashObject {
  enum HashAlgorithm {
    SHA-384 = 0
  }
  HashAlgorithm algorithm = 0;
  int length = 1;
  bytes hash = 2;
}
```

`RecordStreamFile` is a newly defined protobuf message which will be used to serialise all `RecordFileObject`s that are part of the same period into record stream files. Periods are intervals of `hedera.recordStream.logPeriod` seconds used to group `RecordFileObject`s into record stream files.
The record signature file that is created for each record stream file signs the hash of the entire corresponding stream file. The list of sidecar file hashes is included in the record stream file. This way mirror nodes or any interested party can download the record stream file and all sidecar files and verify that:
1. repeated bytes SideCarFileHash is correct; 
2. the signature file signed the correct hash of the entire record stream file;

```
message TransactionSideCarRecord {
    // Consensus timestamp will be the same as the consensus timestamp of the 
    // transaction the side car is related to. This offers a convenient 
    // way to match record to sidecar. 
    Timestamp consensusTimestamp = 1;
    oneof {
      repeated ContractStateChange = 2; // Example sidecar type
      repeated ContractAction = 3; // Example sidecar type
      // Other future categories
    }
}
```

`TransactionSideCarRecord` is a protobuf message which will be used to create sidecar records complementing `TransactionRecord` and storing additional information about a transaction execution. 

```
message SideCarFile {
  // Version of HAPI that was used to serialise the file
  SemanticVersion hapiProtoVersion = 1;

  repeated TransactionSideCarRecord sideCarRecords = 3;
}
```

The `TransactionSideCarRecord`s created by Hedera nodes will be externalised in `SideCarFile` files grouped by the type of the records. Files will be created using the SideCarFile protobuf holding all the `TransactionSideCarRecords` of a same type (e.g. `ContractStateChange`, `ContractAction`) related to `RecordFileObject`s created for the same period.

The `SideCarFile`s will be uploaded into a separate folder in the cloud bucket. Doing so will reduce the number of rows Mirror nodes have to search in S3, reduce S3 list response size, and avoid having to filter them out locally. Probably `recordstreams/record0.0.3/sidecar`.

### Record File Names

A record file name is created using a string representation of the Instant of consensus timestamp of the first transaction in the file using ISO-8601 representation, with colons converted to underscores for Windows compatibility. The block number will be appended to the record file name.

The nano-of-second always outputs nine digits with padding when necessary, to ensure same length filenames and proper sorting.

The sidecar record files will have the same format but will also include the number representing the type of sidecar records that make up that file. This provides an easy way for mirror nodes to download only those files that contain sidecar records they're interested in.

Examples of a record stream file name with corresponding signature file and sidecar record files:

Example 1:
Record File (.rcd): 2020-10-19T21_35_39.000000000Z_432.rcd
Sidecar Record File 1: 2020-10-19T21_35_39.000000000Z_432_1.rcd
Sidecar Record File 2: 2020-10-19T21_35_39.000000000Z_432_2.rcd
Record Signature File(.rcd_sig): 2020-10-19T21_35_39.000000000Z.rcd_sig

Example 2:
Record File (.rcd): 2020-10-19T21_35_39.454265000Z_654.rcd
Sidecar Record File 1: 2020-10-19T21_35_39.454265000Z_654_1.rcd
Sidecar Record File 2: 2020-10-19T21_35_39.454265000Z_654_2.rcd
Record Signature File(.rcd_sig): 2020-10-19T21_35_39.454265000Z.rcd_sig

### Record Stream Flow
![Record Stream Flow](../assets/hip-435/RecordStream.svg "Record Stream Flow")

Transactions are executed sequentially on the Hedera nodes. 
TransactionRecords are created as always. 
Sidecar records are now also created when appropriate.
Record file objects are created grouping Transactions to their corresponding TransactionRecords.
A map of type <> list of sidecar records is populated as well.
Platform receives the list of record file objects and the map. 
Record stream files are created by including all the record file objects, running hashes and the list of sidecar records hashes. 
Sidecar record files are created by grouping all sidecar records of the same type in separate files. The type is the key of the map. For example 1 will represent `ContractStateChange`, 2 will represent `ContractAction`, etc. This will provide a straight-forward and generic way to group sidecar records into files. 


## Backwards Compatibility

The added files can be ignored by clients not wishing to trace or replay smart contract transactions.

Sidecar records for prior transactions will not be created and the verbose information related to them will not be available. This reflects current practice.

## Security Implications

The new Record Stream format doesn't provide any risk in itself. Care should be taken about what kind of information is externalised by each added type of sidecar record file.

## How to Teach This

## Reference Implementation

## Rejected Ideas

## Open Issues

## References


## Copyright/license

This document is licensed under the Apache License, Version 2.0 -- see [LICENSE](../LICENSE) or (https://www.apache.org/licenses/LICENSE-2.0)
